{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "Adds browser based controls to the transit VPC solution ",
    "Parameters": {

        "LambdaBucketName": {
            "Description": "Bucket name for Lambda files",
            "Default": "jrh-lambda-ohio",
            "Type": "String"
        },
        "LambdaExecutionRole": {
            "Description": "Transit Account Assume Role ARN",
            "Default": "arn:aws:iam::106808901653:role/TransitLambdaExecutionRole-transit-account-base",
            "Type": "String"
        },
        "DynamoDbTransitConfig": {
            "Default": "TransitConfig-transit-account-base",
            "Type": "String"
        },
        "paloAltoGroupCapacity": {
            "Default": "4",
            "Type": "String"
        },
        "transitConfigTable": {
            "Default": "TransitConfig-transit-account-base",
            "Type": "String"
        }
    },
    "Resources": {


        "apiCreateTransitVpnLambda": {
            "Type": "AWS::Lambda::Function",

            "Properties": {
                "FunctionName": {
                    "Fn::Join": ["-", ["apiCreateTransitVpnLambda", {
                        "Ref": "AWS::StackName"
                    }]]
                },
                "Description": "Allocate VPN resources from API",
                "Handler": "apiCreateTransit.lambda_handler",
                "Role": {
                    "Ref": "LambdaExecutionRole"
                },
                "Code": {
                    "S3Bucket": {
                        "Ref": "LambdaBucketName"
                    },
                    "S3Key": "ApiLambda.zip"
                },
                "Environment": {
                    "Variables": {
                        "transitConfigTable": {
                            "Ref": "DynamoDbTransitConfig"
                        },
                        "Region": {
                            "Ref": "AWS::Region"
                        }
                    }
                },
                "Runtime": "python3.6",
                "Timeout": "300"
            }
        },
        "apiCreateVgwLambda": {
            "Type": "AWS::Lambda::Function",

            "Properties": {
                "FunctionName": {
                    "Fn::Join": ["-", ["apiCreateVgwLambda", {
                        "Ref": "AWS::StackName"
                    }]]
                },

                "Description": "Allocate VPN resources from API",
                "Handler": "apiCreateVgw.lambda_handler",
                "Role": {
                    "Ref": "LambdaExecutionRole"
                },
                "Code": {
                    "S3Bucket": {
                        "Ref": "LambdaBucketName"
                    },
                    "S3Key": "ApiLambda.zip"
                },
                "Environment": {
                    "Variables": {
                        "paloAltoGroupCapacity": {
                            "Ref": "paloAltoGroupCapacity"
                        },
                        "transitConfigTable": {
                            "Ref": "DynamoDbTransitConfig"
                        },
                        "Region": {
                            "Ref": "AWS::Region"
                        }
                    }
                },
                "Runtime": "python3.6",
                "Timeout": "300"
            }
        },
        "apiDeleteTransitVpnLambda": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": [
                        "-", [
                            "apiDeleteTransitVpnLambda",
                            {
                                "Ref": "AWS::StackName"
                            }
                        ]
                    ]
                },
                "Description": "Allocate VPN resources from API",
                "Handler": "apiDeleteTransitVpnLambda.lambda_handler",
                "Role": {
                    "Ref": "LambdaExecutionRole"
                },
                "Code": {
                    "S3Bucket": {
                        "Ref": "LambdaBucketName"
                    },
                    "S3Key": "ApiLambda.zip"
                },
                "Environment": {
                    "Variables": {
                        "paloAltoGroupCapacity": {
                            "Ref": "paloAltoGroupCapacity"
                        },
                        "transitConfigTable": {
                            "Ref": "DynamoDbTransitConfig"
                        },
                        "Region": {
                            "Ref": "AWS::Region"
                        }
                    }
                },
                "Runtime": "python3.6",
                "Timeout": "300"
            }
        },
        "TransitVpcWebApi": {
            "Type": "AWS::ApiGateway::RestApi",
            "Properties": {
                "Name": "Trasit VPC Web Management API Cors",
                "Description": "Used to manage creation and deletion of Transit VPC connections",
                "FailOnWarnings": true

            }
        },
        "CreateVgwRes": {
            "Type": "AWS::ApiGateway::Resource",
            "DependsOn": [
                "TransitVpcWebApi"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ParentId": {
                    "Fn::GetAtt": ["TransitVpcWebApi", "RootResourceId"]
                },
                "PathPart": "fetchtransvpn"
            }
        },
        "CreateVgwGetMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ResourceId": {
                    "Ref": "CreateVgwRes"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "GET",
                    "Uri": {
                        "Fn::Join": ["", ["arn:aws:apigateway:", {
                            "Ref": "AWS::Region"
                        }, ":lambda:path/2015-03-31/functions/", {
                            "Fn::GetAtt": ["apiCreateVgwLambda", "Arn"]
                        }, "/invocations"]]
                    },
                    "IntegrationResponses":[{"StatusCode" : "200"}]
                },
                "MethodResponses" : [{"StatusCode" : "200","ResponseModels": {"application/json": "Empty"}}]

            }
        },
        "CreateVgwOptionsMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "AuthorizationType": "NONE",
                "HttpMethod": "OPTIONS",
                "MethodResponses": [{
                    "StatusCode": "200",
                    "ResponseParameters": {
                        "method.response.header.Access-Control-Allow-Origin": true,
                        "method.response.header.Access-Control-Allow-Headers": true,
                        "method.response.header.Access-Control-Allow-Methods": true,
                        "method.response.header.Access-Control-Allow-Credentials": true
                    },
                    "ResponseModels": {}
                }],
                "RequestParameters": {},
                "Integration": {
                    "Type": "MOCK",
                    "RequestTemplates": {
                        "application/json": "{statusCode:200}"
                    },
                    "IntegrationResponses": [{
                        "StatusCode": "200",
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Origin": "'*'",
                            "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                            "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,GET'",
                            "method.response.header.Access-Control-Allow-Credentials": "'false'"
                        },
                        "ResponseTemplates": {
                            "application/json": ""
                        }
                    }]
                },
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ResourceId": {
                    "Ref": "CreateVgwRes"
                }
            }
        },
        "DeletetransvpnRes": {
            "Type": "AWS::ApiGateway::Resource",
            "DependsOn": [
                "TransitVpcWebApi"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ParentId": {
                    "Fn::GetAtt": ["TransitVpcWebApi", "RootResourceId"]
                },
                "PathPart": "deletetransvpn"
            }
        },
        "deletetransvpnresourceGetMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ResourceId": {
                    "Ref": "DeletetransvpnRes"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "GET",
                    "Uri": {
                        "Fn::Join": ["", ["arn:aws:apigateway:", {
                            "Ref": "AWS::Region"
                        }, ":lambda:path/2015-03-31/functions/", {
                            "Fn::GetAtt": ["apiDeleteTransitVpnLambda", "Arn"]
                        }, "/invocations"]]
                    },
                    "IntegrationResponses":[{"StatusCode" : "200"}]
                },
                "MethodResponses" : [{"StatusCode" : "200","ResponseModels": {"application/json": "Empty"}}]
            }
        },
        "deletetransvpnresourceOptionsMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "AuthorizationType": "NONE",
                "HttpMethod": "OPTIONS",
                "MethodResponses": [{
                    "StatusCode": "200",
                    "ResponseParameters": {
                        "method.response.header.Access-Control-Allow-Origin": true,
                        "method.response.header.Access-Control-Allow-Headers": true,
                        "method.response.header.Access-Control-Allow-Methods": true,
                        "method.response.header.Access-Control-Allow-Credentials": true
                    },
                    "ResponseModels": {}
                }],
                "RequestParameters": {},
                "Integration": {
                    "Type": "MOCK",
                    "RequestTemplates": {
                        "application/json": "{statusCode:200}"
                    },
                    "IntegrationResponses": [{
                        "StatusCode": "200",
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Origin": "'*'",
                            "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                            "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,GET'",
                            "method.response.header.Access-Control-Allow-Credentials": "'false'"
                        },
                        "ResponseTemplates": {
                            "application/json": ""
                        }
                    }]
                },
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ResourceId": {
                    "Ref": "DeletetransvpnRes"
                }
            }
        },
        "createtransvpnRes": {
            "Type": "AWS::ApiGateway::Resource",
            "DependsOn": [
                "TransitVpcWebApi"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ParentId": {
                    "Fn::GetAtt": ["TransitVpcWebApi", "RootResourceId"]
                },
                "PathPart": "createtransvpn"
            }
        },
        "createtransvpnGetMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ResourceId": {
                    "Ref": "createtransvpnRes"
                },
                "HttpMethod": "GET",
                "AuthorizationType": "NONE",
                "Integration": {
                    "Type": "AWS_PROXY",
                    "IntegrationHttpMethod": "GET",
                    "Uri": {
                        "Fn::Join": ["", ["arn:aws:apigateway:", {
                            "Ref": "AWS::Region"
                        }, ":lambda:path/2015-03-31/functions/", {
                            "Fn::GetAtt": ["apiCreateTransitVpnLambda", "Arn"]
                        }, "/invocations"]]
                    },
                    "IntegrationResponses":[{"StatusCode" : "200"}]
                },
                
                "MethodResponses" : [{"StatusCode" : "200","ResponseModels": {"application/json": "Empty"}}]

            }
        },
        "createtransvpnOptionsMethod": {
            "Type": "AWS::ApiGateway::Method",
            "Properties": {
                "AuthorizationType": "NONE",
                "HttpMethod": "OPTIONS",
                "MethodResponses": [{
                    "StatusCode": "200",
                    "ResponseParameters": {
                        "method.response.header.Access-Control-Allow-Origin": true,
                        "method.response.header.Access-Control-Allow-Headers": true,
                        "method.response.header.Access-Control-Allow-Methods": true,
                        "method.response.header.Access-Control-Allow-Credentials": true
                    },
                    "ResponseModels": {}
                }],
                "RequestParameters": {},
                "Integration": {
                    "Type": "MOCK",
                    "RequestTemplates": {
                        "application/json": "{statusCode:200}"
                    },
                    "IntegrationResponses": [{
                        "StatusCode": "200",
                        "ResponseParameters": {
                            "method.response.header.Access-Control-Allow-Origin": "'*'",
                            "method.response.header.Access-Control-Allow-Headers": "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token,X-Amz-User-Agent'",
                            "method.response.header.Access-Control-Allow-Methods": "'OPTIONS,GET'",
                            "method.response.header.Access-Control-Allow-Credentials": "'false'"
                        },
                        "ResponseTemplates": {
                            "application/json": ""
                        }
                    }]
                },
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "ResourceId": {
                    "Ref": "createtransvpnRes"
                }
            }
        },
        "ApiDeployment": {
            "Type": "AWS::ApiGateway::Deployment",
            "DependsOn": [
                "TransitVpcWebApi","deletetransvpnresourceGetMethod","createtransvpnGetMethod","deletetransvpnresourceGetMethod"
            ],
            "Properties": {
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                }
            }
        },
        "TransitVpcWebApiStage": {
            "Type": "AWS::ApiGateway::Stage",
            "Properties": {
                "DeploymentId": {
                    "Ref": "ApiDeployment"
                },
                "RestApiId": {
                    "Ref": "TransitVpcWebApi"
                },
                "StageName": "Production"
            }
        }
    },
    "Outputs": {}
}
